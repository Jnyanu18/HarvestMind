{
  "entities": {
    "Plant": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Plant",
      "type": "object",
      "description": "Represents a tomato plant and its associated data.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Plant entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the plant."
        },
        "location": {
          "type": "string",
          "description": "Location where the plant is grown."
        },
        "image": {
          "type": "string",
          "description": "Base64 encoded image of the plant."
        }
      },
      "required": [
        "id",
        "name",
        "location",
        "image"
      ]
    },
    "Detection": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Detection",
      "type": "object",
      "description": "Represents the detection results for a given plant image.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Detection entity."
        },
        "plantId": {
          "type": "string",
          "description": "Reference to Plant. (Relationship: Plant 1:N Detection)"
        },
        "detectionCount": {
          "type": "number",
          "description": "Number of tomatoes detected in the image."
        },
        "boxes": {
          "type": "array",
          "description": "Bounding box coordinates for each detected tomato (xyxy).",
          "items": {
            "type": "string"
          }
        },
        "stageCounts": {
          "type": "string",
          "description": "Counts of tomatoes in each growth stage (immature, ripening, mature)."
        },
        "growthStage": {
          "type": "string",
          "description": "Overall growth stage of the plant (Immature, Ripening, Mature)."
        },
        "avgBboxArea": {
          "type": "number",
          "description": "Average bounding box area of detected tomatoes."
        },
        "confidence": {
          "type": "number",
          "description": "Confidence level of the detection."
        }
      },
      "required": [
        "id",
        "plantId",
        "detectionCount",
        "boxes",
        "stageCounts",
        "growthStage",
        "avgBboxArea",
        "confidence"
      ]
    },
    "Forecast": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Forecast",
      "type": "object",
      "description": "Represents the yield forecast for a given plant, based on various parameters.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Forecast entity."
        },
        "plantId": {
          "type": "string",
          "description": "Reference to Plant. (Relationship: Plant 1:N Forecast)"
        },
        "detectionId": {
          "type": "string",
          "description": "Reference to Detection. (Relationship: Detection 1:1 Forecast)"
        },
        "yieldNowKg": {
          "type": "number",
          "description": "Current estimated yield in kilograms."
        },
        "sellableKg": {
          "type": "number",
          "description": "Estimated sellable yield after accounting for post-harvest loss."
        },
        "dailyForecast": {
          "type": "array",
          "description": "Array of daily forecast data (date, ready_kg, gdd_cum).",
          "items": {
            "type": "string"
          }
        },
        "harvestPlan": {
          "type": "array",
          "description": "Array representing the harvest plan (date, harvest_kg).",
          "items": {
            "type": "string"
          }
        },
        "notes": {
          "type": "array",
          "description": "Notes or observations about the forecast.",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "plantId",
        "detectionId",
        "yieldNowKg",
        "sellableKg",
        "dailyForecast",
        "harvestPlan",
        "notes"
      ]
    },
    "MarketData": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "MarketData",
      "type": "object",
      "description": "Represents the market data and price forecasts.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the MarketData entity."
        },
        "forecastId": {
          "type": "string",
          "description": "Reference to Forecast. (Relationship: Forecast 1:1 MarketData)"
        },
        "forecast": {
          "type": "array",
          "description": "Array of forecasted market prices (date, price).",
          "items": {
            "type": "string"
          }
        },
        "bestDate": {
          "type": "string",
          "description": "The date with the best forecasted price."
        },
        "bestPrice": {
          "type": "number",
          "description": "The best forecasted price."
        },
        "modelInfo": {
          "type": "string",
          "description": "Information about the market forecasting model used."
        }
      },
      "required": [
        "id",
        "forecastId",
        "forecast",
        "bestDate",
        "bestPrice",
        "modelInfo"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}/plants/{plantId}",
        "definition": {
          "entityName": "Plant",
          "schema": {
            "$ref": "#/backend/entities/Plant"
          },
          "description": "Stores plant data. Each plant is owned by a user. Includes 'userId' in the path for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The ID of the user who owns the plant."
            },
            {
              "name": "plantId",
              "description": "The ID of the plant."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/plants/{plantId}/detections/{detectionId}",
        "definition": {
          "entityName": "Detection",
          "schema": {
            "$ref": "#/backend/entities/Detection"
          },
          "description": "Stores detection data for a specific plant. Each detection is owned by the plant's owner. Includes 'userId' and 'plantId' in the path for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The ID of the user who owns the plant and the detection."
            },
            {
              "name": "plantId",
              "description": "The ID of the plant to which the detection belongs."
            },
            {
              "name": "detectionId",
              "description": "The ID of the detection."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/plants/{plantId}/detections/{detectionId}/forecasts/{forecastId}",
        "definition": {
          "entityName": "Forecast",
          "schema": {
            "$ref": "#/backend/entities/Forecast"
          },
          "description": "Stores forecast data for a specific detection. Each forecast is owned by the detection's owner. Includes 'userId', 'plantId', and 'detectionId' in the path for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The ID of the user who owns the plant, detection and the forecast."
            },
            {
              "name": "plantId",
              "description": "The ID of the plant to which the detection and forecast belong."
            },
            {
              "name": "detectionId",
              "description": "The ID of the detection to which forecast belongs."
            },
            {
              "name": "forecastId",
              "description": "The ID of the forecast."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/plants/{plantId}/detections/{detectionId}/forecasts/{forecastId}/marketData/{marketDataId}",
        "definition": {
          "entityName": "MarketData",
          "schema": {
            "$ref": "#/backend/entities/MarketData"
          },
          "description": "Stores market data for a specific forecast. Each market data entry is owned by the forecast's owner. Includes 'userId', 'plantId', 'detectionId', and 'forecastId' in the path for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The ID of the user who owns the plant, detection, forecast, and the market data."
            },
            {
              "name": "plantId",
              "description": "The ID of the plant to which the detection, forecast and market data belong."
            },
            {
              "name": "detectionId",
              "description": "The ID of the detection to which forecast and market data belong."
            },
            {
              "name": "forecastId",
              "description": "The ID of the forecast to which the market data belongs."
            },
            {
              "name": "marketDataId",
              "description": "The ID of the market data."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to organize data related to plants, detections, forecasts, and market data. Each entity is stored in its own collection. Since all data is private and related to individual user activity, a top-level `/users/{userId}` collection is introduced to guarantee private data and simple rules.\n\n**Authorization Independence (CRITICAL):** This design achieves Authorization Independence by avoiding hierarchical authorization dependencies. All entities inherit the authorization context via path-based ownership (`/users/{userId}`), eliminating the need for `get()` calls in security rules. Since there are no collaborative access patterns, no denormalization is needed.\n\n**Structural Segregation (Homogeneous Security Posture):** Each collection stores only one type of entity, ensuring that all documents within a collection share the same security requirements. This simplifies security rules.\n\n**QAPs (Rules are not Filters):** This structure enables secure `list` operations by enforcing path-based ownership. Rules can easily check `request.auth.uid == userId` to ensure that users can only access data they own.\n\n**Data Clarity and Predictability:** The schema uses explicit state modeling and predictable schema, making the data structure clear and easy to understand. Naming conventions are also consistent."
  }
}